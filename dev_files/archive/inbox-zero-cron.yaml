properties:
  managedEnvironmentId: /subscriptions/57aa22c1-1b18-40c5-ab91-0d9c9059d0a9/resourceGroups/rg-keystone-platform/providers/Microsoft.App/managedEnvironments/keystone-platform-aca-env
  configuration:
    secrets:
      - name: cron-secret
        value: 9d02bb639a9e4a7f0fa29c79882b19d796ecc7f5343e802d67742df62ed33fdf
  template:
    containers:
      - image: alpine:latest
        name: inbox-zero-cron
        command:
          - /bin/sh
        args:
          - -c
          - |
            apk add --no-cache curl
            WATCH_INTERVAL=21600
            MEETING_BRIEFS_INTERVAL=900
            LAST_WATCH=0
            while true; do
              NOW=$(date +%s)
              echo "[cron] Processing meeting briefs..."
              curl -s -X GET "http://inbox-zero-web:3000/api/meeting-briefs" \
                -H "Authorization: Bearer ${CRON_SECRET}" || echo "[cron] Warning: meeting-briefs request failed"
              if [ $((NOW - LAST_WATCH)) -ge $WATCH_INTERVAL ]; then
                echo "[cron] Renewing email watches..."
                curl -s -X GET "http://inbox-zero-web:3000/api/watch/all" \
                  -H "Authorization: Bearer ${CRON_SECRET}" || echo "[cron] Warning: watch request failed"
                LAST_WATCH=$NOW
              fi
              echo "[cron] Sleeping for 15 minutes..."
              sleep $MEETING_BRIEFS_INTERVAL
            done
        env:
          - name: CRON_SECRET
            secretRef: cron-secret
        resources:
          cpu: 0.25
          memory: 0.5Gi
    scale:
      minReplicas: 1
      maxReplicas: 1
